<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Duyệt Kinh Điển</title>
	<link rel="stylesheet" href="./public/plugins/fontawesome/css/all.min.css">
	<link rel="stylesheet" href="./public/plugins/sweetalert2/sweetalert2.min.css">
	<link rel="stylesheet" href="./public/css/adminlte.min.css">
	<link rel="stylesheet" href="./public/css/mystyle.css">
	<script type="text/javascript">
		function iframeChange()
		{
			document.getElementById('post-frame').contentWindow.onkeyup = function()
			{
				frameToHtmlCode();
			};

			document.getElementById('post-frame').contentDocument.onchange = function()
			{
				frameToHtmlCode();
			};
		}
	</script>
</head>

<body class="hold-transition sidebar-mini layout-navbar-fixed layout-fixed">

	<div class="wrapper">

		<nav class="main-header navbar navbar-expand border-bottom-0 text-sm navbar-light" id="header">
			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
				</li>
				<li class="nav-item d-none d-sm-inline-block">
					<a href="./" class="nav-link"><i class="fas fa-home"></i></a>
				</li>
			</ul>
			<ul class="navbar-nav ml-auto">
				<li class="nav-item">
					<a href="/calendar.html" class="nav-link" id="my-clock"><i class="far fa-clock"></i></a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-comments"></i>
						<span class="badge badge-danger navbar-badge">0</span>
					</a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-bell"></i>
						<span class="badge badge-warning navbar-badge">0</span>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
						<i class="fas fa-th-large"></i>
					</a>
				</li>
			</ul>
		</nav>

		<aside class="main-sidebar sidebar-dark-primary elevation-4">
			<a href="./" class="brand-link text-md">
				<img src="https://graph.facebook.com/100007543845219/picture?height=100&width=100&access_token=6628568379%7Cc1e620fa708a1d5696fb991c1bde5662" class="brand-image img-circle elevation-3">
				<span class="brand-text font-weight-light" id="hello-user">MY LEARN</span>
			</a>
			<div class="sidebar">
				
			</div>
		</aside>

		<aside class="control-sidebar control-sidebar-dark">
			<div class="p-3">
				<h5>Thanh Công Cụ</h5>
				<div class="mb-4"><input type="checkbox" id="dark-mode" class="mr-1"><span>Dark Mode</span></div>
				
				<button class="btn btn-sm btn-default" id="fast-highlight"><span class="badge bg-success" id="fast-number"></span> <i class="fas fa-spell-check"></i> highlight</button>
				<textarea class="form-control" id="fast-content" rows="8"></textarea>
				<select class="form-control" id="fast-categories">
				</select>
				<select class="form-control" id="fast-courses">
				</select>
				<button class="btn btn-sm btn-primary" id="fast-knowledge"><i class="fas fa-edit"></i> Kiến Tạo</button>
			</div>
		</aside>

		<div class="content-wrapper">
			<div class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1 class="m-0">Duyệt Kinh Điển (<span id="post-count"></span>)</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="content">
				<div class="container-fluid" id="page-box">

					<div class="row">
						<div class="col-sm-7">
							<div class="card card-default">
								<div class="card-header">
									<h3 class="card-title"></h3>
									<div class="card-tools">
										<ul class="nav nav-pills ml-auto">
											<li class="nav-item">
												<button class="btn btn-sm btn-primary" id="post-sync">Đồng Bộ Trải Nghiệm (<span id="sync-count"></span>)</button>
											</li>
											<li class="nav-item">
												<button class="btn btn-sm btn-success" id="post-approval">Phê Duyệt Vào CSDL <span id="post-index"></span></button>
											</li>
											<li class="nav-item">
												<button class="btn btn-sm btn-warning" id="post-skip">Không duyệt <span id="temp-index"></span></button>
											</li>
										</ul>
									</div>
								</div>
								<div class="card-body">
									<div class="form-group">
										<label class="col-form-label" for="post-title"><i class="fas fa-spa"></i> Tiêu Đề</label>
										<input type="text" class="form-control" id="post-title" value="">
									</div>
									<div class="row">
										<div class="col-sm-4">
											<div class="form-group">
												<label><i class="fas fa-map-marker-alt"></i> source</label>
												<input type="text" class="form-control" id="post-source" value="">
											</div>
										</div>
										<div class="col-sm-4">
											<div class="form-group">
												<label><i class="fas fa-cubes"></i> category</label>
												<input type="text" class="form-control" id="post-category" value="">
											</div>
										</div>
										<div class="col-sm-4">
											<div class="form-group">
												<label><i class="fas fa-tags"></i> tags</label>
												<input type="text" class="form-control" id="post-tags" value="">
											</div>
										</div>
									</div>
									<div class="row">
										<div class="col-sm-4">
											<div class="form-group">
												<label><i class="fas fa-user-edit"></i> creator</label>
												<input type="text" class="form-control" id="post-creator" value="">
											</div>
										</div>
										<div class="col-sm-4">
											<div class="form-group">
												<label><i class="far fa-calendar-minus"></i> created</label>
												<input type="text" class="form-control" id="post-created" value="">
											</div>
										</div>
										<div class="col-sm-4">
											<div class="form-group">
												<label><i class="far fa-thumbs-up"></i> vote</label>
												<input type="text" class="form-control" id="post-vote" value="">
											</div>
										</div>
									</div>
									<div class="form-group">
										<label class="col-form-label" for="post-slug"><i class="fas fa-paperclip"></i> slug</label>
										<input type="text" class="form-control" id="post-slug" value="">
									</div>
									<div class="row">
										<div class="col-sm-9">
											<div class="form-group">
												<label class="col-form-label" for="post-image"><i class="fas fa-image"></i> image</label>
												<input type="text" class="form-control" id="post-image" value="">
											</div>
											<div class="form-group">
												<label class="col-form-label" for="post-link"><a href="#" class="post-link" target="_blank"><i class="fas fa-link"></i> link</a></label>
												<input type="text" class="form-control" id="post-link" value="">
											</div>
										</div>
										<div class="col-sm-3">
											<a href="#" class="post-link" target="_blank"><img id="post-avatar" class="attachment-img elevation-2" src="#$crawl->image"></a>
										</div>
									</div>
								</div>
							</div>
						</div>
						<div class="col-sm-5">
							<div class="card card-default">
								<div class="card-header">
									<h3 class="card-title">Nội dung kinh điển</h3>
								</div>
								<div class="card-body">
									<div class="form-group">
										<textarea class="form-control" rows="20" id="post-content"></textarea>
										<label class="btn btn-sm btn-default" id="post-view">HTML Preview <i class="fas fa-arrow-down"></i></label>
										<label class="btn btn-sm btn-default" onclick="frameToHtmlCode()">HTML Update <i class="fas fa-arrow-up"></i></label>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="row">
						<iframe width="100%" height="100px" id="post-frame" onload="iframeChange()"></iframe>
					</div>

				</div>
			</div>
		</div>

		<footer class="main-footer">
			<div class="text-center">** Cắp sách đi học Trường Đời - Cố thêm 1 Chút thôi - Thừa hơn Thiếu **</div>
		</footer>
	</div>
	<div id="back-to-top" onclick="backToTop()"><i class="fa fa-chevron-up"></i></div>
	<script src="./public/plugins/jquery/jquery.min.js"></script>
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-firestore.js"></script>
	<script src="./public/plugins/moment/moment.min.js"></script>
	<script src="./public/plugins/sweetalert2/sweetalert2.min.js"></script>
	<script src="./public/js/adminlte.min.js"></script>
	<script src="./public/js/myfirebase.js"></script>
	<script src="./public/js/myscript.js"></script>
	<script type="text/javascript">

		var postIndex = 0;
		var tempIndex = 0;

		var url = new URL(window.location.href);

		fetch(url.origin+'/pages/posts.json')
		.then(response => response.text())
		.then(data => {
			var obj = JSON.parse(data);
			$('#sync-count').text(obj.length);
		});

		/* get first temp data */
		rtdb.ref('temps/').limitToFirst(1).on('value', function(snapshot) {
			let value = snapshot.val();
			//console.log(value);
			// reset form
			$('#post-source').val('');
			$('#post-category').val('');
			$('#post-tags').val('');
			$('#post-title').val('');
			$('#post-vote').val('');
			$('#post-creator').val('');
			$('#post-created').val('');
			$('#post-image').val('');
			$('#post-link').val('');
			$('#post-slug').val('');
			$('#post-content').val('');
			$('#post-avatar').attr('src', '#');
			$('a.post-link').attr('href', '#');
			$('#post-content').val('');

			if (value)
			{
				tempIndex = Object.keys(value)[0];
				$('#temp-index').text('#' + tempIndex);

				value = value[tempIndex];

				$('#post-source').val(value.source);
				$('#post-category').val(value.category);
				$('#post-tags').val(value.tags);
				$('#post-title').val(value.title);
				$('#post-vote').val(value.vote);
				$('#post-creator').val(value.creator);
				$('#post-created').val(value.created);
				$('#post-image').val(value.image);
				$('#post-link').val(value.link);
				$('#post-slug').val(value.slug);
				$('#post-content').val(value.content);

				$('#post-avatar').attr('src', value.image);
				$('a.post-link').attr('href', value.link);

				fetch(url.origin+'/pages/'+value.source+'/'+value.slug+'.html')
				.then(response => response.text())
				.then(data => {
					$('#post-content').val(data);
				});
				// enable approval
				$('#post-approval').prop('disabled', false);
				$('#post-skip').prop('disabled', false);
			}
		});

		/* get last temp index */
		var lastTemp = 0;
		rtdb.ref('temps/').orderByKey().limitToLast(1).on('value', function(snapshot) {
			let value = snapshot.val();
			if (value) {
				lastTemp = Object.keys(value)[0];
				$('#post-sync').prop('disabled', true);
			}
			else
			{
				lastTemp = 0;
			}
			$('#post-count').text(lastTemp);
		});

		/* get last index */
		fsdb.collection("posts").orderBy("index", "desc").limit(1).get().then((querySnapshot) => {
			querySnapshot.forEach((doc) => {
				let docdata = doc.data();
				$('#post-index').text(docdata.index);
			});
		})
		.catch((error) => {
			console.log(error);
		});

		// update posts.json to database
		$('#post-sync').click(function ()
		{
			fetch(url.origin+'/pages/posts.json')
			.then(response => response.text())
			.then(data => {
				var objs = JSON.parse(data);

				for (var i = 0; i < objs.length; i++)
				{
					var obj = objs[i];
					var num_stt = i + 1;

					rtdb.ref('temps/' + num_stt).set({
						source: obj.source,
						category: obj.category,
						tags: obj.tags,
						title: obj.title,
						slug: obj.slug,
						vote: obj.vote,
						creator: obj.creator,
						created: obj.created,
						image: obj.image,
						link: obj.link,
						file: obj.file
					})
					.then(() => {
						// Data saved successfully!
					}).catch((error) => {
						console.log(error);
					});
				}
			});
		})

		$('#post-approval').click(function ()
		{
			$('#post-approval').prop('disabled', true);
			$('#post-skip').prop('disabled', true);

			let source = $('#post-source').val().trim();
			let category = $('#post-category').val().trim();
			let tags = $('#post-tags').val().trim();
			let title = $('#post-title').val().trim();
			let vote = $('#post-vote').val().trim();
			let creator = $('#post-creator').val().trim();
			let created = $('#post-created').val().trim();
			let image = $('#post-image').val().trim();
			let link = $('#post-link').val().trim();
			let slug = $('#post-slug').val().trim();
			//let content = $('#post-content').val().trim();

			if (title == '' || slug == '')
			{
				alert('Không có tiêu đề, slug');
				return;
			}

			vote = Number(vote);
			created = moment(created).unix();
			++postIndex;

			fsdb.collection("posts").add({
				index: postIndex,
				source: source,
				category: category,
				tags: tags,
				title: title,
				vote: vote,
				creator: creator,
				created: created,
				image: image,
				link: link,
				slug: slug,
				number_reads: 0
			})
			.then((docRef) => {
				console.log("OK Document ID: ", docRef.id);
				// remove temp post
				rtdb.ref('temps/' + tempIndex).remove().catch((error) => console.log(error));
			})
			.catch((error) => {
				console.log(error);
			});
		})

		$('#post-skip').click(function ()
		{
			$('#post-approval').prop('disabled', true);
			$('#post-skip').prop('disabled', true);
			rtdb.ref('temps/' + tempIndex).remove().catch((error) => console.log(error));
		});

		$('#post-image').change(function () {
			$('#post-avatar').attr('src', this.value);
		})

		$('#post-view').click(function ()
		{
			htmlCodeToFrame();
		});

		$('#post-title').change(function () {
			$('#post-slug').val(TextToSlug(this.value));
		})

		function htmlCodeToFrame()
		{
			var myContent = $('#post-content').val();
			myContent = '<body contentEditable="true">' + myContent + '</body>';

			var iframeView = document.getElementById('post-frame').contentWindow || document.getElementById('post-frame').contentDocument;
			iframeView.document.write(myContent);
			iframeView.document.close();

			//change the height of the iframe
			document.getElementById('post-frame').height = (iframeView.document.body.offsetHeight + 50) + 'px';
		}

		function frameToHtmlCode()
		{
			var iframeView = document.getElementById('post-frame').contentWindow || document.getElementById('post-frame').contentDocument;
			myContent = iframeView.document.documentElement.outerHTML;
			myContent = myContent.replace('<html>', '').replace('<head>', '').replace('</head>', '').replace('<body contenteditable="true">', '');
			myContent = myContent.replace('<body>', '').replace('</body>', '').replace('</html>', '');
			myContent = myContent.replace('contenteditable="true"', '').replace('contenteditable="false"', '').replace(/contenteditable|contentEditable/gm, '');
			$('#post-content').val(myContent);
		}
	</script>
</body>
</html>