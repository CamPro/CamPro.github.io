<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Kho Tàng Tri Thức</title>
	<link rel="stylesheet" href="./public/plugins/fontawesome/css/all.min.css">
	<link rel="stylesheet" href="./public/plugins/sweetalert2/sweetalert2.min.css">
	<!-- DataTables -->
	<link rel="stylesheet" href="./public/plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
	<link rel="stylesheet" href="./public/plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
	<link rel="stylesheet" href="./public/plugins/datatables-buttons/css/buttons.bootstrap4.min.css">
	<link rel="stylesheet" href="./public/css/adminlte.min.css">
	<link rel="stylesheet" href="./public/css/mystyle.css">
</head>
<body class="hold-transition sidebar-mini layout-navbar-fixed layout-fixed">
	<div class="wrapper">
		<nav class="main-header navbar navbar-expand border-bottom-0 text-sm navbar-light" id="header">
			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
				</li>
				<li class="nav-item d-none d-sm-inline-block">
					<a href="./" class="nav-link"><i class="fas fa-home"></i></a>
				</li>
			</ul>
			<ul class="navbar-nav ml-auto">
				<li class="nav-item">
					<a href="/calendar.html" class="nav-link" id="my-clock"><i class="far fa-clock"></i></a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-comments"></i>
						<span class="badge badge-danger navbar-badge">0</span>
					</a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-bell"></i>
						<span class="badge badge-warning navbar-badge">0</span>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
						<i class="fas fa-th-large"></i>
					</a>
				</li>
			</ul>
		</nav>

		<aside class="main-sidebar sidebar-dark-primary elevation-4">
			<a href="./" class="brand-link text-md">
				<img src="https://graph.facebook.com/100007543845219/picture?height=100&width=100&access_token=6628568379%7Cc1e620fa708a1d5696fb991c1bde5662" class="brand-image img-circle elevation-3">
				<span class="brand-text font-weight-light" id="hello-user">MY LEARN</span>
			</a>
			<div class="sidebar">
				<div class="form-inline">
					<div class="input-group" data-widget="sidebar-search">
						<input class="form-control form-control-sidebar" type="search" placeholder="Search" aria-label="Search">
						<div class="input-group-append">
							<button class="btn btn-sidebar">
								<i class="fas fa-search fa-fw"></i>
							</button>
						</div>
					</div>
					<div class="sidebar-search-results">
						<div class="list-group">
						</div>
					</div>
				</div>
				<nav class="mt-2 text-sm">

				</nav>
			</div>
		</aside>

		<aside class="control-sidebar control-sidebar-dark">
			<div class="p-3">
				<h5>Thanh Công Cụ</h5>
				<div class="mb-4"><input type="checkbox" id="dark-mode" class="mr-1"><span>Dark Mode</span></div>
				
				<button class="btn btn-sm btn-default" id="fast-highlight"><span class="badge bg-success" id="fast-number"></span> <i class="fas fa-spell-check"></i> highlight</button>
				<textarea class="form-control" id="fast-content" rows="8"></textarea>
				<select class="form-control" id="fast-categories">
				</select>
				<select class="form-control" id="fast-courses">
				</select>
				<button class="btn btn-sm btn-primary" id="fast-knowledge"><i class="fas fa-edit"></i> Kiến Tạo</button>
			</div>
		</aside>

		<div class="content-wrapper">
			<div class="content-header">
				<div class="container-fluid">
					<div class="row mb-2">
						<div class="col-sm-6">
							<h1 class="m-0">Kho Tàng Tri Thức</h1>
						</div>
					</div>
				</div>
			</div>
			<div class="content">
				<div class="container-fluid">
					<div class="row">
						<div class="col-lg-12">
							<div class="table-responsive">
								<table id="posts_datatable" class="table table-bordered table-striped text-nowrap">
									<thead>
									</thead>
									<tbody>
									</tbody>
								</table>
							</div>
						</div>
					</div>
					<div class="row">

						<div class="col-sm-6">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">
										<div class="">
											<input list="sources" type="text" class="form-control" id="post-source" value="">
											<datalist id="sources">
												<option value="spiderum">Spiderum</option>
												<option value="monsterbox">Monster Box</option>
											</datalist>
										</div>
									</h3>
								</div>
								<div class="card-body p-0">
									<ul class="products-list product-list-in-card pl-2 pr-2" id="list-new-post">
									</ul>
								</div>
								<div class="card-footer text-center">
									<a href="javascript:void(0)" class="uppercase btn btn-" id="list-new-more">Xem thêm</a>
								</div>
							</div>
						</div>

						<div class="col-sm-6">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">Tàng Kinh Các</h3>
								</div>
								<div class="card-body p-0">
									<ul class="products-list product-list-in-card pl-2 pr-2" id="list-top-post">

									</ul>
								</div>
								<div class="card-footer text-center">
									<a href="javascript:void(0)" class="uppercase btn btn-" id="list-top-more">Xem thêm</a>
								</div>
							</div>
						</div>

						<div class="col-sm-6">
							<div class="card">
								<div class="card-header">
									<h3 class="card-title">Kinh Thư Còn Ấp Ủ</h3>
								</div>
								<div class="card-body p-0">
									<ul class="products-list product-list-in-card pl-2 pr-2" id="list-read-post">

									</ul>
								</div>
								<div class="card-footer text-center">
									<a href="javascript:void(0)" class="uppercase btn btn-" id="list-read-more">Xem thêm</a>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</div>

		<footer class="main-footer">
			<div class="text-center">** Cắp sách đi học Trường Đời - Cố thêm 1 Chút thôi - Thừa hơn Thiếu **</div>
		</footer>
	</div>
	<div id="back-to-top" onclick="backToTop()"><i class="fa fa-chevron-up"></i></div>
	<script src="./public/plugins/jquery/jquery.min.js"></script>
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-firestore.js"></script>
	<!-- DataTables  & Plugins -->
	<script src="./public/plugins/datatables/jquery.dataTables.min.js"></script>
	<script src="./public/plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
	<script src="./public/plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
	<script src="./public/plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
	<script src="./public/plugins/datatables-buttons/js/dataTables.buttons.min.js"></script>
	<script src="./public/plugins/datatables-buttons/js/buttons.bootstrap4.min.js"></script>
	<script src="./public/plugins/datatables-buttons/js/buttons.html5.min.js"></script>
	<script src="./public/plugins/datatables-buttons/js/buttons.print.min.js"></script>
	<script src="./public/plugins/datatables-buttons/js/buttons.colVis.min.js"></script>
	<!--  -->
	<script src="./public/plugins/moment/moment.min.js"></script>
	<script src="./public/plugins/sweetalert2/sweetalert2.min.js"></script>
	<script src="./public/js/adminlte.min.js"></script>
	<script src="./public/js/myfirebase.js"></script>
	<script src="./public/js/myscript.js"></script>
	<script type="text/javascript">
		var limit_post = 5;
		var lastNew = null;
		var lastTop = null;
		var lastRead = null;

		var firstNew = fsdb.collection("posts").orderBy("created", "desc").limit(3).get()
		.then((querySnapshot) => {
			querySnapshot.forEach((doc) => {
				RenderList(doc, '#list-new-post');
				lastNew = doc;
			});
		})
		.catch((error) => {
			console.log(error);
		});

		var firstTop = fsdb.collection("posts").orderBy("vote", "desc").limit(3).get()
		.then((querySnapshot) => {
			querySnapshot.forEach((doc) => {
				RenderList(doc, '#list-top-post');
				lastTop = doc;
			});
		})
		.catch((error) => {
			console.log(error);
		});

		var firstRead = fsdb.collection("posts").orderBy("number_reads", "asc").limit(3).get()
		.then((querySnapshot) => {
			querySnapshot.forEach((doc) => {
				RenderList(doc, '#list-read-post');
				lastRead = doc;
			});
		})
		.catch((error) => {
			console.log(error);
		});

		var dataSet = [];
		let json_posts = localStorage.getItem("posts");
		if (json_posts) {
			dataSet = JSON.parse(json_posts);
		}

		var data_table = $('#posts_datatable').DataTable({
			"paging": true,
			"lengthChange": true,
			"searching": true,
			"ordering": true,
			"info": true,
			"autoWidth": false,
			"responsive": false,
			"data": dataSet,
			"buttons": ["copy", "csv", "print", "colvis", {
				text: 'Làm mới tất cả Kinh Điển',
				action: function ( e, dt, node, config ) {
					fsdb.collection("posts").get()
					.then((querySnapshot) => {

						dataSet = [];

						querySnapshot.forEach((doc) => {
							let docid = doc.id;
							let docdata = doc.data();

							let objs = {
								'id': docid
							};
							Object.assign(objs, docdata);

							// giam du lieu luu tru
							delete objs.image;

							dataSet.push(objs);
						});

						data_table = $('#posts_datatable').DataTable();
						data_table.clear(); // Clear your data
						data_table.rows.add(dataSet); // Add rows with newly updated data
						data_table.draw(); //then draw it

						localStorage.setItem("posts", JSON.stringify(dataSet));

						Toast.fire({ icon: 'success', title: 'Đã làm mới xong.' });
					})
					.catch((error) => {
						console.log(error);
					});
				}
			}],
			"columns": [
				{
					"data": "title",
					"title": "Tiêu Đề",
					"render": function ( data, type, row, meta ) {
						let linkurl = './post.html?source=' + row.source + '&slug=' + row.slug + '&docid=' + row.id;
						return '<a href="' + linkurl + '" target="_blank">' + row.title + '</a>';
					}
				},
				{
					"data": "score",
					"title": "Điểm"
				},
				{
					"data": "source",
					"title": "Nguồn Gốc"
				},
				{
					"data": "category",
					"title": "Chủ Đề"
				},
				{
					"data": "creator",
					"title": "Người tạo"
				},
				{
					"data": "created",
					"title": "Ngày Tạo",
					"render": function ( data, type, row, meta ) {
						let created = moment.unix(row.created).format("YYYY-MM-DD");//format("DD/MM/YYYY");
						return created;
					}
				},
				{
					"data": "vote",
					"title": "Like"
				},
			],
		}).buttons().container().prependTo('#posts_datatable_wrapper');

		$('.dataTables_filter input').css('width', 500);

		$('#list-new-more').click(function ()
		{
			var select_source = $('#post-source').val();
			if (select_source)
			{
				fsdb.collection("posts").where('source', '==', select_source).orderBy("created", "desc").startAfter(lastNew).limit(limit_post).get()
				.then((querySnapshot) => {
					querySnapshot.forEach((doc) => {
						RenderList(doc, '#list-new-post');
						lastNew = doc;
					});
				})
				.catch((error) => {
					console.log(error);
				});
			}
			else
			{
				fsdb.collection("posts").orderBy("created", "desc").startAfter(lastNew).limit(limit_post).get()
				.then((querySnapshot) => {
					querySnapshot.forEach((doc) => {
						RenderList(doc, '#list-new-post');
						lastNew = doc;
					});
				})
				.catch((error) => {
					console.log(error);
				});
			}
		})

		$('#list-top-more').click(function ()
		{
			fsdb.collection("posts").orderBy("vote", "desc").startAfter(lastTop).limit(limit_post).get()
			.then((querySnapshot) => {
				querySnapshot.forEach((doc) => {
					RenderList(doc, '#list-top-post');
					lastTop = doc;
				});
			})
			.catch((error) => {
				console.log(error);
			});
		})

		$('#list-read-more').click(function ()
		{
			fsdb.collection("posts").orderBy("number_reads", "asc").startAfter(lastRead).limit(limit_post).get()
			.then((querySnapshot) => {
				querySnapshot.forEach((doc) => {
					RenderList(doc, '#list-read-post');
					lastRead = doc;
				});
			})
			.catch((error) => {
				console.log(error);
			});
		})

		function RenderList(doc, ul)
		{
			let docid = doc.id;
			let docdata = doc.data();

			let created = moment.unix(docdata.created).format("DD/MM/YYYY");
			let linkurl = './post.html?source=' + docdata.source + '&slug=' + docdata.slug + '&docid=' + docid;

			var item = '<li class="item">';
			item += '<div class="product-img">';
			item += '<a href="' + linkurl + '" target="_blank"><img src="' + docdata.image + '" class="img-size-50" style="width: 50px !important;"></a>';
			item += '</div>';
			item += '<div class="product-info">';
			item += '<a href="' + linkurl + '" class="product-title">' + docdata.title;
			item += '<span class="badge text-success float-right"><i class="far fa-thumbs-up"></i> ' + docdata.vote + '</span>';
			item += '</a>';
			item += '<span class="product-description">';
			item += '<div class="card-comment">';
			item += '<div class="comment-text">';
			item += '<span class="username">';
			item += '<b>' + docdata.creator + '</b>';
			item += '<span class="text-muted float-right">' + created + '</span>';
			item += '</span>';
			item += '</div>';
			item += '</div>';
			item += '<div class="card-comment">';
			item += '<div class="comment-text">' + docdata.category;
			item += '<div class="float-right"><small><a href="' + docdata.link + '" class="text-gray" target="_blank" id="post-link"><i class="fas fa-external-link-alt"></i></a></small> <small><a href="/post_edit.html?docid=' + docid + '" class="text-gray" id="post-link"><i class="fas fa-edit"></i></a></small></div>';
			item += '</div>';
			item += '</div>';
			item += '</span>';
			item += '</div>';
			item += '</li>';

			$(ul).append(item);
		}

	</script>
</body>
</html>