<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Khai Sáng Bản Ngã</title>
	<link rel="stylesheet" href="./public/plugins/fontawesome/css/all.min.css">
	<link rel="stylesheet" href="./public/plugins/sweetalert2/sweetalert2.min.css">
	<link rel="stylesheet" href="./public/css/adminlte.min.css">
	<link rel="stylesheet" href="./public/css/mystyle.css">
</head>

<body class="hold-transition sidebar-mini layout-navbar-fixed layout-fixed">

	<div class="wrapper">

		<nav class="main-header navbar navbar-expand border-bottom-0 text-sm navbar-light" id="header">
			<ul class="navbar-nav">
				<li class="nav-item">
					<a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
				</li>
				<li class="nav-item d-none d-sm-inline-block">
					<a href="./" class="nav-link"><i class="fas fa-home"></i></a>
				</li>
			</ul>
			<ul class="navbar-nav ml-auto">
				<li class="nav-item">
					<a href="/calendar.html" class="nav-link" id="my-clock"><i class="far fa-clock"></i></a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-comments"></i>
						<span class="badge badge-danger navbar-badge">0</span>
					</a>
				</li>
				<li class="nav-item dropdown">
					<a class="nav-link" data-toggle="dropdown" href="#">
						<i class="far fa-bell"></i>
						<span class="badge badge-warning navbar-badge">0</span>
					</a>
				</li>
				<li class="nav-item">
					<a class="nav-link" data-widget="control-sidebar" data-slide="true" href="#" role="button">
						<i class="fas fa-th-large"></i>
					</a>
				</li>
			</ul>
		</nav>

		<aside class="main-sidebar sidebar-dark-primary elevation-4">
			<a href="./" class="brand-link text-md">
				<img src="https://graph.facebook.com/100007543845219/picture?height=100&width=100&access_token=6628568379%7Cc1e620fa708a1d5696fb991c1bde5662" class="brand-image img-circle elevation-3">
				<span class="brand-text font-weight-light" id="hello-user">MY LEARN</span>
			</a>
			<div class="sidebar">
				<div class="form-inline">
					<div class="input-group" data-widget="sidebar-search">
						<input class="form-control form-control-sidebar" type="search" placeholder="Search" aria-label="Search">
						<div class="input-group-append">
							<button class="btn btn-sidebar">
								<i class="fas fa-search fa-fw"></i>
							</button>
						</div>
					</div>
					<div class="sidebar-search-results">
						<div class="list-group">
						</div>
					</div>
				</div>
				<nav class="mt-2 text-sm">

				</nav>
			</div>
		</aside>

		<aside class="control-sidebar control-sidebar-dark">
			<div class="p-3">
				<h5>Thanh Công Cụ</h5>
				<div class="mb-4"><input type="checkbox" id="dark-mode" class="mr-1"><span>Dark Mode</span></div>
				
				<button class="btn btn-sm btn-default" id="fast-highlight"><span class="badge bg-success" id="fast-number"></span> <i class="fas fa-spell-check"></i> highlight</button>
				<textarea class="form-control" id="fast-content" rows="8"></textarea>
				<select class="form-control" id="fast-categories">
				</select>
				<select class="form-control" id="fast-courses">
				</select>
				<button class="btn btn-sm btn-primary" id="fast-knowledge"><i class="fas fa-edit"></i> Kiến Tạo</button>
			</div>
		</aside>
		<div class="content-wrapper">
			<div class="content-header">
				<div class="container-fluid">
					<div class="row">
						<div class="col-lg-12">
							<h2 class="m-0" id="post-title"></h2>
						</div>
					</div>
					<div class="row">
						<div class="col-lg-2"><i class="fas fa-map-marker-alt"></i> <span id="post-source"></span></div>
						<div class="col-lg-2"><i class="fas fa-user-edit"></i> <span id="post-creator"></span></div>
						<div class="col-lg-3"><i class="fas fa-cubes"></i> <span id="post-category"></span></div>
						<div class="col-lg-2"><i class="far fa-thumbs-up"></i> <span id="post-vote"></span></div>
						<div class="col-lg-2"><i class="far fa-calendar-minus"></i> <span id="post-created"></span></div>
					</div>
					<div class="row">
						<div class="col-lg-6">
							<div class="row">
								<div class="col-lg-2">
									<a href="" target="_blank" id="post-link"><button class="btn btn-sm btn-default"><i class="fas fa-external-link-alt"></i> Gốc</button></a>
								</div>
								<div class="col-lg-2">
									<a href="" id="post-edit"><button class="btn btn-sm btn-default"><i class="fas fa-edit"></i> Sửa</button></a>
								</div>
								<div class="col-lg-2">
									<button class="btn btn-sm btn-default" id="post-delete"><i class="fas fa-trash"></i> Xóa</button>
								</div>
								<div class="col-lg-2">
									<span class="input-group-append">
										<button type="button" class="btn btn-default btn-sm" id="page-col-minus"><i class="fas fa-minus"></i></button>
										<button type="button" class="btn btn-default btn-sm" id="page-col-plus"><i class="fas fa-plus"></i></button>
									</span>
								</div>
								<div class="col-lg-3">
									<button class="btn btn-sm btn-default post-favourite"><i class="fas fa-gem"></i> <span>Thích</span></button>
								</div>
							</div>
						</div>
						<div class="col-lg-4">
							<span class="icon-star" data-star="1" data-toggle="tooltip" data-html="true" title="<h4>1 điểm</h4><p>- Nên đọc 0-1 lần</p><p>- Nên xoá</p>"><i class="far fa-star"></i></span>
							<span class="icon-star" data-star="2" data-toggle="tooltip" data-html="true" title="<h4>2 điểm</h4><p>- Nên đọc 1-2 lần</p><p>- Nên xoá</p>"><i class="far fa-star"></i></span>
							<span class="icon-star" data-star="3" data-toggle="tooltip" data-html="true" title="<h4>3 điểm</h4><p>- Nên đọc 1-3 lần</p><p>- Có thể xoá</p>"><i class="far fa-star"></i></span>
							<span class="icon-star" data-star="4" data-toggle="tooltip" data-html="true" title="<h4>4 điểm</h4><p>- Nên đọc 1-4 lần</p><p>- Có thể xoá</p>"><i class="far fa-star"></i></span>
							<span class="icon-star" data-star="5" data-toggle="tooltip" data-html="true" title="<h4>5 điểm: Hay khá</h4><p>- Nên đọc 1-5 lần</p><p>- Có thể xoá</p>"><i class="far fa-star"></i></span>
							&nbsp;
							<span class="icon-star" data-star="6" data-toggle="tooltip" data-html="true" title="<h4>6 điểm: Hay chuẩn</h4><p>- Nên đọc nhiều lần</p><p></p>"><i class="far fa-star"></i></span>
							<span class="icon-star" data-star="7" data-toggle="tooltip" data-html="true" title="<h4>7 điểm: Hay quá</h4><p>- Nên đọc nhiều lần</p><p></p>"><i class="far fa-star"></i></span>
							<span class="icon-star" data-star="8" data-toggle="tooltip" data-html="true" title="<h4>8 điểm: Xuất sắc khá</h4><p>- Nên đọc nhiều lần</p>"><i class="far fa-star"></i></span>
							<span class="icon-star" data-star="9" data-toggle="tooltip" data-html="true" title="<h4>9 điểm: Xuất sắc chuẩn</h4><p>- Nên đọc nhiều lần</p> <p>- Nên in ra giấy</p>"><i class="far fa-star"></i></span>
							<span class="icon-star" data-star="10" data-toggle="tooltip" data-html="true" title="<h4>10 điểm: Xuất sắc vượt trội</h4><p>- Nên đọc nhiều lần</p> <p>- Nên in ra giấy</p>"><i class="far fa-star"></i></span>
							<span class="icon-description text-orange text-bold"></span>
						</div>
						<div class="col-lg-2"><span id="post-length"></span></div>
					</div>
				</div>
			</div>
			<div class="content">
				<div class="container-fluid text-lg">
					<div class="row">
						<div class="col-lg-6 ml-auto mr-auto">
							<div id="post-content">
								*Nội dung*
							</div>
						</div>
					</div>
				</div>
				<div class="clearfix"></div>
				<div class="text-center">
					<span class="text-yellow">Hey!, chấm điểm đi:</span>
					<span class="icon-star" data-star="1" data-toggle="tooltip" title="1 điểm"><i class="far fa-star"></i></span>
					<span class="icon-star" data-star="2" data-toggle="tooltip" title="2 điểm"><i class="far fa-star"></i></span>
					<span class="icon-star" data-star="3" data-toggle="tooltip" title="3 điểm"><i class="far fa-star"></i></span>
					<span class="icon-star" data-star="4" data-toggle="tooltip" title="4 điểm"><i class="far fa-star"></i></span>
					<span class="icon-star" data-star="5" data-toggle="tooltip" title="5 điểm"><i class="far fa-star"></i></span>
					&nbsp;
					<span class="icon-star" data-star="6" data-toggle="tooltip" title="6 điểm"><i class="far fa-star"></i></span>
					<span class="icon-star" data-star="7" data-toggle="tooltip" title="7 điểm"><i class="far fa-star"></i></span>
					<span class="icon-star" data-star="8" data-toggle="tooltip" title="8 điểm"><i class="far fa-star"></i></span>
					<span class="icon-star" data-star="9" data-toggle="tooltip" title="9 điểm"><i class="far fa-star"></i></span>
					<span class="icon-star" data-star="10" data-toggle="tooltip" title="10 điểm"><i class="far fa-star"></i></span>
					<span class="icon-description text-orange text-bold"></span>
				</div>
			</div>
		</div>

		<footer class="main-footer">
			<div class="text-center">** Cắp sách đi học Trường Đời - Cố thêm 1 Chút thôi - Thừa hơn Thiếu **</div>
		</footer>
	</div>
	<div id="back-to-top" onclick="backToTop()"><i class="fa fa-chevron-up"></i></div>
	<script src="./public/plugins/jquery/jquery.min.js"></script>
	<script src="./public/plugins/bootstrap/bootstrap.bundle.min.js"></script>
	<!-- The core Firebase JS SDK is always required and must be listed first -->
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.7.1/firebase-firestore.js"></script>
	<script src="./public/plugins/moment/moment.min.js"></script>
	<script src="./public/plugins/sweetalert2/sweetalert2.min.js"></script>
	<script src="./public/js/adminlte.min.js"></script>
	<script src="./public/js/myfirebase.js"></script>
	<script src="./public/js/myscript.js"></script>
	<script type="text/javascript">
		let source = "";
		let slug = "";
		let docid = "";

		var important_words = ['sự thật', 'thật sự', 'tư duy'];

		var url = new URL(window.location.href);
		source = url.searchParams.get("source");
		slug = url.searchParams.get("slug");
		docid = url.searchParams.get("docid");

		fetch(url.origin+'/pages/'+source+'/'+slug+'.html')
		.then(response => response.text())
		.then(data => {
			// highlight
			data = HighlightImportantWords(data);

			$('#post-content').html(data);

			let post_length = $('#post-content').text().split(' ').length;
			$('#post-length').html('<b>' + post_length + '</b> chữ - <b>' + Math.round(parseInt(post_length)/300) + '</b> phút');
		});

		fsdb.collection("posts").doc(docid).get().then((doc) => {
			if (doc.exists)
			{
				let docdata = doc.data();
				$('#post-title').text(docdata.title);
				$('#post-source').text(docdata.source);
				$('#post-creator').text(docdata.creator);
				$('#post-category').text(docdata.category);
				$('#post-vote').text(docdata.vote);

				$('#post-link').attr('href', docdata.link);
				$('#post-edit').attr('href', '/post_edit.html?docid='+docid);

				let created = moment.unix(docdata.created).format("DD/MM/YYYY");
				$('#post-created').text(created);

				ShowScore(docdata.score);

				if (docdata.title) {
					document.title = docdata.title;
				}
			}
			else
			{
				$('.content-header .container-fluid').html("Không tìm thấy dữ liệu!");
			}
		}).catch((error) => {
			Toast.fire({ icon: 'error', title: error });
			console.log("Error getting document:", error);
		});

		$('[data-toggle="tooltip"]').tooltip();

		$('#post-delete').click(function ()
		{
			if (!confirm('Xóa kinh điển vĩnh viễn?'))
			{
				return;
			}
			fsdb.collection("posts").doc(docid).delete()
			.then(() => {
				Toast.fire({ icon: 'success', title: 'Đã xoá.' });
			})
			.catch((error) => {
				Toast.fire({ icon: 'error', title: error });
			});
		});

		$('.icon-star').click(function () {
			var score = $(this).data('star');
			score = parseInt(score);

			ShowScore(score);

			fsdb.collection("posts").doc(docid).update({
				score: score
			}).then(() => {}).catch((error) => {
				ShowScore(0);
				Toast.fire({ icon: 'error', title: error });
			});
		})

		$('#page-col-plus').click(function ()
		{
			var content_class = $('#post-content').parent().attr('class');

			var col_number = content_class.match(/\d+/)[0];
			col_number = parseInt(col_number) + 1;
			
			if (col_number > 12) {
				return;
			}

			content_class = content_class.replace(/\d+/, col_number);

			$('#post-content').parent().attr('class', content_class);
		});

		$('#page-col-minus').click(function ()
		{
			var content_class = $('#post-content').parent().attr('class');

			var col_number = content_class.match(/\d+/)[0];
			col_number = parseInt(col_number) - 1;
			
			if (col_number < 1) {
				return;
			}

			content_class = content_class.replace(/\d+/, col_number);

			$('#post-content').parent().attr('class', content_class);
		});

		$('.post-favourite').click(function () {
			$(this).addClass('text-blue text-bold').find('span').text('Yêu thích')
		})

		function ShowScore(score)
		{
			$('.icon-description').html(score + ' điểm.');

			for (var i = 1; i <= 10; i++) {
				if (i <= score) {
					$('[data-star="'+i+'"]').addClass('text-orange').find('i').removeClass('far').addClass('fas');
				} else {
					$('[data-star="'+i+'"]').removeClass('text-orange').find('i').removeClass('fas').addClass('far');
				}
			}
		}

		function HighlightImportantWords(text) {
			important_words.forEach(word => {
				let select_text = word.toLocaleLowerCase();
				let index = 0;
				while (index >= 0) {
					let data_finder = text.toLocaleLowerCase();
					index = data_finder.indexOf(select_text, index);
					console.log(index)
					if (index >= 0)
					{
						text = text.substring(0, index) + "<span class='text-red'>" + text.substring(index, index + select_text.length) + "</span>" + text.substring(index + select_text.length);
						index += 25;
					}
					else
					{
						break;
					}
				}
			})
			return text;
		}

	</script>
</body>
</html>